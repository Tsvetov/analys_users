CREATE OR REPLACE FUNCTION add_subnetwork() RETURNS
TRIGGER AS $$
DECLARE
    sub_network_new varchar(30);
    sub_network_new_tmp varchar(30) ARRAY;
    ar_sub_network varchar(30) ARRAY;
BEGIN
    sub_network_new_tmp = string_to_array(text(NEW.ip_address), '.');

    sub_network_new = array_to_string(sub_network_new_tmp[0:3], '.');

    IF (SELECT count(*) FROM analys_users_usersubnetwork WHERE user_id = NEW.user_id) > 0 THEN
        ar_sub_network = (SELECT sub_networks FROM analys_users_usersubnetwork WHERE user_id = NEW.user_id);
        IF sub_network_new <> ALL (ar_sub_network)  THEN
            UPDATE analys_users_usersubnetwork SET sub_networks=array_append(ar_sub_network, sub_network_new) where user_id = NEW.user_id;
        END IF;
        RETURN NEW;
    ELSE
        INSERT INTO analys_users_usersubnetwork(user_id, sub_networks) values (NEW.user_id,array[sub_network_new]);
        RETURN NEW;
    END IF;
END;
$$ LANGUAGE plpgsql;



CREATE TRIGGER t_user
AFTER INSERT ON
analys_users_userip FOR EACH ROW EXECUTE PROCEDURE add_subnetwork();